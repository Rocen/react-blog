(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{451:function(t,s,n){"use strict";n.r(s);var a=n(16),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"usetransition"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#usetransition"}},[t._v("#")]),t._v(" useTransition")]),t._v(" "),n("p",[n("code",[t._v("React")]),t._v("官网对于"),n("code",[t._v("Transition")]),t._v("的描述：")]),t._v(" "),n("blockquote",[n("p",[t._v("Transitions 是 React 18 引入的一个全新的并发特性。它允许你将标记更新作为一个 transitions，这会告诉 React 它们可以被中断执行，并避免回到已经可见内容的 Suspense 降级方案。")])]),t._v(" "),n("p",[t._v("从源码的角度来看这句话的关键在于"),n("strong",[t._v("可以被中断执行")]),t._v("，那么说明使用"),n("code",[t._v("useTransition")]),t._v("触发的更新对应的优先级是相对较低的，因为它可以被中断。那么我猜测，最适合它的优先级应该是"),n("code",[t._v("DefaultLane")]),t._v("。")]),t._v(" "),n("p",[n("code",[t._v("useTransition")]),t._v("的使用方法：")]),t._v(" "),n("blockquote",[n("p",[t._v("const [isPending, startTransition] = useTransition();")])]),t._v(" "),n("p",[t._v("返回一个状态值表示过渡任务的等待状态，以及一个启动该过渡任务的函数。")]),t._v(" "),n("p",[t._v("从使用方法上看，它的返回值对应的数据类型和"),n("code",[t._v("useState")]),t._v("是极其相似的。"),n("code",[t._v("isPending")]),t._v("是一个变量，"),n("code",[t._v("startTransition")]),t._v("是一个启动过渡任务的函数。所以可以推测出，在实现上这两个"),n("code",[t._v("hook")]),t._v("一定是有所关联的。")]),t._v(" "),n("h2",{attrs:{id:"用途"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#用途"}},[t._v("#")]),t._v(" 用途")]),t._v(" "),n("p",[t._v("我们知道，新版本"),n("code",[t._v("React")]),t._v("最大的特点就是并发特性。并发特性是指，页面中在同一时刻可以同时存在多种更新，并且根据各自的优先级高低按照顺序依次执行，在更新执行的过程中也不会阻塞浏览器的渲染。")]),t._v(" "),n("p",[t._v("所以，只要在页面中所有非紧急的更新都可以使用"),n("code",[t._v("useTransition")]),t._v("。")]),t._v(" "),n("p",[t._v("举例来说：在网上商城的购物车页面，一般会有最常用的三个属性：商品单价、商品数量和所选商品总金额。")]),t._v(" "),n("p",[t._v("当我们通过点击-、+按钮来改变某个商品的数量，产生变化的地方有两个：商品数量和总金额。那么我们就需要在点击事件里面通过"),n("code",[t._v("useState")]),t._v("方法去改变商品数量和总金额这个两个变量。")]),t._v(" "),n("p",[t._v("但是，如果我们仔细思考的话，其实可以把这两个变量的更新做出优先级的区分。当用户点击的时候，一定是希望立刻得到反馈，这个反馈体现在页面上就是商品数量马上改变。那么改变商品的数量这个更新就应该立即执行，所以它的优先级一定是最高的。")]),t._v(" "),n("p",[t._v("相对的，改变总金额的更新对应的优先级就是相对较低的，因为总金额涉及到商品金额和数量的计算过程，可能还包括优惠打折、满减等复杂情况。所以页面上总金额的变化是可以延迟一段时间，等到商品数量已经渲染完成之后再进行总金额的渲染。")]),t._v(" "),n("p",[t._v("例子：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("App")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setNum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setCount"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("useState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("isPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" startTransition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("useTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("handleClick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setNum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("n")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" n "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("startTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("c")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" c "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button onClick"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("handleClick"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("数量 "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n          价格："),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("元\n          数量："),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          合计："),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("isPending "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'计算中...'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" count"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("通过点击事件会触发两个更新，"),n("code",[t._v("setNum")]),t._v("改变商品数量，"),n("code",[t._v("setCount")]),t._v("改变总金额。区别是"),n("code",[t._v("setNum")]),t._v("会立即触发，而"),n("code",[t._v("setCount")]),t._v("被包裹在"),n("code",[t._v("startTransition")]),t._v("的回调函数中，会等到"),n("code",[t._v("setCount")]),t._v("执行结束后再执行。")]),t._v(" "),n("h2",{attrs:{id:"usetransition的实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#usetransition的实现"}},[t._v("#")]),t._v(" useTransition的实现")]),t._v(" "),n("p",[n("code",[t._v("mount")]),t._v("和"),n("code",[t._v("update")]),t._v("，"),n("code",[t._v("useTranstion")]),t._v("方法在源码中分别对应的"),n("code",[t._v("mountTransition")]),t._v("和"),n("code",[t._v("updateTransition")]),t._v("。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mountTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("boolean"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("isPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mountState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The `start` method never changes.")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("startTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" setPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mountWorkInProgressHook")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  hook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("isPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("boolean"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("isPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateState")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hook "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateWorkInProgressHook")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" start "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" hook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("memoizedState"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("isPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("从这段代码可以看到，主要的工作都是在"),n("code",[t._v("mountTransition")]),t._v("中进行的，"),n("code",[t._v("updateTransition")]),t._v("只负责取数据而已。并且可以明显的看到，"),n("code",[t._v("isPending")]),t._v("这个变量是使用"),n("code",[t._v("useState")]),t._v("返回的，所以也印证之前对于两者存在关联的猜测。")]),t._v(" "),n("p",[t._v("再看下启动该过渡任务的函数"),n("code",[t._v("startTransition")]),t._v("：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("startTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("setPending"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取当前更新的优先级")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" previousPriority "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCurrentUpdatePriority")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置优先级，优先级的值取决于previousPriority和ContinuousEventPriority两者之间优先级更高的")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCurrentUpdatePriority")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("higherEventPriority")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("previousPriority"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ContinuousEventPriority"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发改变isPending的状态更新，对应的优先级是不低于ContinuousEventPriority")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setPending")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置transition标识，表示触发了transition")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevTransition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ReactCurrentBatchConfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  ReactCurrentBatchConfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发改变isPending的状态更新")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setPending")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行回调函数")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重置优先级")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCurrentUpdatePriority")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("previousPriority"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ReactCurrentBatchConfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("transition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" prevTransition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("从这段代码可以看到，在"),n("code",[t._v("startTransition")]),t._v("至少可能触发三个状态更新，分别为："),n("code",[t._v("setPending(true)")]),t._v("、"),n("code",[t._v("setPending(false)")]),t._v("和"),n("code",[t._v("callback()")]),t._v("。因为"),n("code",[t._v("setPending")]),t._v("方法是通过"),n("code",[t._v("mountState")]),t._v("暴露出来的，所以使用"),n("code",[t._v("setPending")]),t._v("就会触发一次状态更新。而"),n("code",[t._v("callback")]),t._v("是使用"),n("code",[t._v("startTransition")]),t._v("传入的回调函数，在回调函数内部使用了"),n("code",[t._v("setCount")]),t._v("，所以也会触发一次状态更新。")]),t._v(" "),n("p",[t._v("获取"),n("code",[t._v("transition")]),t._v("相关的优先级的代码：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NoTransition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLanes"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000001111111111111111000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane1"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000001000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane2"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000010000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane3"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000100000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane4"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000001000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane5"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000010000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane6"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000100000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane7"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000001000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane8"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000010000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane9"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000100000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane10"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000001000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane11"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000010000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane12"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000100000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane13"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000001000000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane14"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000010000000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane15"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000100000000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TransitionLane16"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000001000000000000000000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestUpdateLane")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("fiber"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Fiber")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// order code...")]),t._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// requestCurrentTransition会返回ReactCurrentBatchConfig.transition的值")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isTransition "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("requestCurrentTransition")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoTransition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// transition值")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("isTransition"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// currentEventTransitionLane是全局变量")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("currentEventTransitionLane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" NoLane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果当前事件不存在TransitionLane，则需要获取")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 同一事件内所有transition都被分配同一个lane")]),t._v("\n      currentEventTransitionLane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("claimNextTransitionLane")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回currentEventTransitionLane")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" currentEventTransitionLane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// order code...")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("claimNextTransitionLane")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通过车道，分配每个新的transition到下一个车道。")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在大多数情况下，每个transition都有自己的车道，直到用完所有的lane并循环回到最开始的lane。")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" lane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" nextTransitionLane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将nextTransitionLane左移一位")]),t._v("\n  nextTransitionLane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 用来判断transtion相关的lane是否用完")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// nextTransitionLane按位与TransitionLanes，如果为空，说明transitionLane都用完了")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nextTransitionLane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" TransitionLanes"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将nextTransitionLane重置为TransitionLane1，即从头开始分配transtionLane")]),t._v("\n    nextTransitionLane "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TransitionLane1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 返回")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" lane"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("从这段代码可以看到，与"),n("code",[t._v("transition")]),t._v("相关的"),n("code",[t._v("lane")]),t._v("一共有"),n("em",[t._v("16")]),t._v("位，说明可以最多存储"),n("em",[t._v("16")]),t._v("个不同的"),n("code",[t._v("transition")]),t._v("。")]),t._v(" "),n("p",[t._v("至于为什么需要这么多位来存储"),n("code",[t._v("transition")]),t._v("，我猜测可能是为了应付并发场景的上限。虽然"),n("code",[t._v("transition")]),t._v("相比其他高优先级是比较低，但是当存在多个"),n("code",[t._v("transiton")]),t._v("时，他们之间也会存在优先级的相对关系。虽然都是通过"),n("code",[t._v("startTransition")]),t._v("的回调函数触发，但是还是应该有一个执行的前后顺序。先触发的"),n("code",[t._v("transition")]),t._v("就应该先执行，而后触发的"),n("code",[t._v("transition")]),t._v("就得后执行。")]),t._v(" "),n("p",[t._v("综上所述，使用点击事件"),n("code",[t._v("handleClick")]),t._v("最终会触发四次状态更新。")]),t._v(" "),n("p",[t._v("执行"),n("code",[t._v("setNum")]),t._v("会触发第一次状态更新，它对应的优先级是"),n("code",[t._v("SyncLane")]),t._v("。")]),t._v(" "),n("p",[t._v("执行"),n("code",[t._v("setPending(true)")]),t._v("会触发第二次状态更新，它会根据当前存在更新的优先级和"),n("code",[t._v("ContinuousEventPriority")]),t._v("之间值更高的，显然"),n("code",[t._v("SyncLane")]),t._v("值更高，所以它对应的优先级也是"),n("code",[t._v("SyncLane")]),t._v("。")]),t._v(" "),n("p",[t._v("执行"),n("code",[t._v("setPending(false)")]),t._v("会触发第三次状态更新，因为在这之前已经设置了"),n("code",[t._v("ReactCurrentBatchConfig.transition = 1")]),t._v("，所以接下来触发更新的优先级应该都是"),n("code",[t._v("transitionLane")]),t._v("。因为此时"),n("code",[t._v("currentEventTransitionLane")]),t._v("还没有值，所以会通过"),n("code",[t._v("claimNextTransitionLane")]),t._v("方法获取"),n("code",[t._v("lane")]),t._v("。"),n("code",[t._v("nextTransitionLane")]),t._v("的初始值是"),n("code",[t._v("TransitionLane1")]),t._v("，所以第三次状态更新对应的优先级就是"),n("code",[t._v("TransitionLane1")]),t._v("。")]),t._v(" "),n("p",[t._v("执行"),n("code",[t._v("callback")]),t._v("内的"),n("code",[t._v("setCount")]),t._v("会触发第四次状态更新，也会进入获取"),n("code",[t._v("transitionLane")]),t._v("的逻辑。此时"),n("code",[t._v("currentEventTransitionLane")]),t._v("是有值的，为前一次更新的优先级"),n("code",[t._v("TransitionLane1")]),t._v("，所以第四次状态更新对应的优先级也是"),n("code",[t._v("TransitionLane1")]),t._v("。")]),t._v(" "),n("p",[t._v("经过上述的分析结果，再结合"),n("strong",[t._v("批量更新")]),t._v("：相同优先级的更新会"),n("strong",[t._v("合并")]),t._v("到一次状态更新流程。")]),t._v(" "),n("p",[t._v("结论：点击"),n("code",[t._v("handleClick")]),t._v("事件最终会触发两次组件渲染。第一次渲染会计算相同高优先级的"),n("code",[t._v("setNum")]),t._v("和"),n("code",[t._v("setPending(true)")]),t._v("。第二次渲染会计算相同低优先级的"),n("code",[t._v("setPending(false)")]),t._v("和"),n("code",[t._v("setCount")]),t._v("。")])])}),[],!1,null,null,null);s.default=e.exports}}]);