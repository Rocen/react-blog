<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>useTransition | React笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/react-blog/logo.svg">
    <meta name="description" content="React">
    
    <link rel="preload" href="/react-blog/assets/css/0.styles.7c9b7da0.css" as="style"><link rel="preload" href="/react-blog/assets/js/app.1296abc1.js" as="script"><link rel="preload" href="/react-blog/assets/js/2.2aa2ea89.js" as="script"><link rel="preload" href="/react-blog/assets/js/35.58ce8424.js" as="script"><link rel="prefetch" href="/react-blog/assets/js/10.eec084d2.js"><link rel="prefetch" href="/react-blog/assets/js/11.90e7ad9c.js"><link rel="prefetch" href="/react-blog/assets/js/12.ec712917.js"><link rel="prefetch" href="/react-blog/assets/js/13.5fd1705f.js"><link rel="prefetch" href="/react-blog/assets/js/14.33d6319e.js"><link rel="prefetch" href="/react-blog/assets/js/15.b49ac970.js"><link rel="prefetch" href="/react-blog/assets/js/16.915d1a33.js"><link rel="prefetch" href="/react-blog/assets/js/17.0d48f94a.js"><link rel="prefetch" href="/react-blog/assets/js/18.162dd664.js"><link rel="prefetch" href="/react-blog/assets/js/19.897cc694.js"><link rel="prefetch" href="/react-blog/assets/js/20.c0d68b54.js"><link rel="prefetch" href="/react-blog/assets/js/21.23f5c8b7.js"><link rel="prefetch" href="/react-blog/assets/js/22.17cddd5f.js"><link rel="prefetch" href="/react-blog/assets/js/23.3e2c069f.js"><link rel="prefetch" href="/react-blog/assets/js/24.16287cbc.js"><link rel="prefetch" href="/react-blog/assets/js/25.c9819b86.js"><link rel="prefetch" href="/react-blog/assets/js/26.03bcf156.js"><link rel="prefetch" href="/react-blog/assets/js/27.2e75196a.js"><link rel="prefetch" href="/react-blog/assets/js/28.71dcfa28.js"><link rel="prefetch" href="/react-blog/assets/js/29.0534c7d4.js"><link rel="prefetch" href="/react-blog/assets/js/3.1f92403b.js"><link rel="prefetch" href="/react-blog/assets/js/30.70a1b1a5.js"><link rel="prefetch" href="/react-blog/assets/js/31.8d8007c6.js"><link rel="prefetch" href="/react-blog/assets/js/32.f55b2b21.js"><link rel="prefetch" href="/react-blog/assets/js/33.dea713d0.js"><link rel="prefetch" href="/react-blog/assets/js/34.16302cd1.js"><link rel="prefetch" href="/react-blog/assets/js/36.21c87dbf.js"><link rel="prefetch" href="/react-blog/assets/js/37.e9ccbb00.js"><link rel="prefetch" href="/react-blog/assets/js/38.eda7b7d3.js"><link rel="prefetch" href="/react-blog/assets/js/39.28c4eb15.js"><link rel="prefetch" href="/react-blog/assets/js/4.ace4b147.js"><link rel="prefetch" href="/react-blog/assets/js/40.13eceae9.js"><link rel="prefetch" href="/react-blog/assets/js/41.e5e3f4ba.js"><link rel="prefetch" href="/react-blog/assets/js/42.1ab022fc.js"><link rel="prefetch" href="/react-blog/assets/js/43.eca03ba8.js"><link rel="prefetch" href="/react-blog/assets/js/44.be104c53.js"><link rel="prefetch" href="/react-blog/assets/js/5.68075c63.js"><link rel="prefetch" href="/react-blog/assets/js/6.01147cc3.js"><link rel="prefetch" href="/react-blog/assets/js/7.630cc1a8.js"><link rel="prefetch" href="/react-blog/assets/js/8.80d0f023.js"><link rel="prefetch" href="/react-blog/assets/js/9.f8d3ba3a.js">
    <link rel="stylesheet" href="/react-blog/assets/css/0.styles.7c9b7da0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/react-blog/" class="home-link router-link-active"><!----> <span class="site-name">React笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://next-blog.irocen.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  nextjs笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/Rocen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://next-blog.irocen.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  nextjs笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/Rocen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/react-blog/" class="sidebar-heading clickable router-link-active"><span>开始</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-blog/docs/start/directory.html" class="sidebar-link">目录</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>理念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>概念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Hooks</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-blog/docs/hooks/useStateAnduseReducer.html" class="sidebar-link">useState和useReducer</a></li><li><a href="/react-blog/docs/hooks/useEffect.html" class="sidebar-link">useEffect</a></li><li><a href="/react-blog/docs/hooks/executeUseEffect.html" class="sidebar-link">useEffect的执行</a></li><li><a href="/react-blog/docs/hooks/useRef.html" class="sidebar-link">useRef</a></li><li><a href="/react-blog/docs/hooks/useMemoAnduseCallback.html" class="sidebar-link">useMemo和useCallback</a></li><li><a href="/react-blog/docs/hooks/useTransition.html" aria-current="page" class="active sidebar-link">useTransition</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react-blog/docs/hooks/useTransition.html#usetransition" class="sidebar-link">useTransition</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/hooks/useTransition.html#用途" class="sidebar-link">用途</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/hooks/useTransition.html#usetransition的实现" class="sidebar-link">useTransition的实现</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Concurrent Mode</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实现</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>发现</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="usetransition"><a href="#usetransition" class="header-anchor">#</a> useTransition</h2> <p><code>React</code>官网对于<code>Transition</code>的描述：</p> <blockquote><p>Transitions 是 React 18 引入的一个全新的并发特性。它允许你将标记更新作为一个 transitions，这会告诉 React 它们可以被中断执行，并避免回到已经可见内容的 Suspense 降级方案。</p></blockquote> <p>从源码的角度来看这句话的关键在于<strong>可以被中断执行</strong>，那么说明使用<code>useTransition</code>触发的更新对应的优先级是相对较低的，因为它可以被中断。那么我猜测，最适合它的优先级应该是<code>DefaultLane</code>。</p> <p><code>useTransition</code>的使用方法：</p> <blockquote><p>const [isPending, startTransition] = useTransition();</p></blockquote> <p>返回一个状态值表示过渡任务的等待状态，以及一个启动该过渡任务的函数。</p> <p>从使用方法上看，它的返回值对应的数据类型和<code>useState</code>是极其相似的。<code>isPending</code>是一个变量，<code>startTransition</code>是一个启动过渡任务的函数。所以可以推测出，在实现上这两个<code>hook</code>一定是有所关联的。</p> <h2 id="用途"><a href="#用途" class="header-anchor">#</a> 用途</h2> <p>我们知道，新版本<code>React</code>最大的特点就是并发特性。并发特性是指，页面中在同一时刻可以同时存在多种更新，并且根据各自的优先级高低按照顺序依次执行，在更新执行的过程中也不会阻塞浏览器的渲染。</p> <p>所以，只要在页面中所有非紧急的更新都可以使用<code>useTransition</code>。</p> <p>举例来说：在网上商城的购物车页面，一般会有最常用的三个属性：商品单价、商品数量和所选商品总金额。</p> <p>当我们通过点击-、+按钮来改变某个商品的数量，产生变化的地方有两个：商品数量和总金额。那么我们就需要在点击事件里面通过<code>useState</code>方法去改变商品数量和总金额这个两个变量。</p> <p>但是，如果我们仔细思考的话，其实可以把这两个变量的更新做出优先级的区分。当用户点击的时候，一定是希望立刻得到反馈，这个反馈体现在页面上就是商品数量马上改变。那么改变商品的数量这个更新就应该立即执行，所以它的优先级一定是最高的。</p> <p>相对的，改变总金额的更新对应的优先级就是相对较低的，因为总金额涉及到商品金额和数量的计算过程，可能还包括优惠打折、满减等复杂情况。所以页面上总金额的变化是可以延迟一段时间，等到商品数量已经渲染完成之后再进行总金额的渲染。</p> <p>例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> setNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> startTransition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setNum</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token operator">=&gt;</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>数量 <span class="token operator">+</span> <span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
          价格：<span class="token number">10</span>元
          数量：<span class="token punctuation">{</span>num<span class="token punctuation">}</span>
          合计：<span class="token punctuation">{</span>isPending <span class="token operator">?</span> <span class="token string">'计算中...'</span> <span class="token operator">:</span> count<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过点击事件会触发两个更新，<code>setNum</code>改变商品数量，<code>setCount</code>改变总金额。区别是<code>setNum</code>会立即触发，而<code>setCount</code>被包裹在<code>startTransition</code>的回调函数中，会等到<code>setCount</code>执行结束后再执行。</p> <h2 id="usetransition的实现"><a href="#usetransition的实现" class="header-anchor">#</a> useTransition的实现</h2> <p><code>mount</code>和<code>update</code>，<code>useTranstion</code>方法在源码中分别对应的<code>mountTransition</code>和<code>updateTransition</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>boolean<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// The `start` method never changes.</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token function">startTransition</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> setPending<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hook<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span>boolean<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从这段代码可以看到，主要的工作都是在<code>mountTransition</code>中进行的，<code>updateTransition</code>只负责取数据而已。并且可以明显的看到，<code>isPending</code>这个变量是使用<code>useState</code>返回的，所以也印证之前对于两者存在关联的猜测。</p> <p>再看下启动该过渡任务的函数<code>startTransition</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token parameter">setPending<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取当前更新的优先级</span>
  <span class="token keyword">const</span> previousPriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置优先级，优先级的值取决于previousPriority和ContinuousEventPriority两者之间优先级更高的</span>
  <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>
    <span class="token function">higherEventPriority</span><span class="token punctuation">(</span>previousPriority<span class="token punctuation">,</span> ContinuousEventPriority<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 触发改变isPending的状态更新，对应的优先级是不低于ContinuousEventPriority</span>
  <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置transition标识，表示触发了transition</span>
  <span class="token keyword">const</span> prevTransition <span class="token operator">=</span> ReactCurrentBatchConfig<span class="token punctuation">.</span>transition<span class="token punctuation">;</span>
  ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 触发改变isPending的状态更新</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行回调函数</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重置优先级</span>
    <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> prevTransition<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从这段代码可以看到，在<code>startTransition</code>至少可能触发三个状态更新，分别为：<code>setPending(true)</code>、<code>setPending(false)</code>和<code>callback()</code>。因为<code>setPending</code>方法是通过<code>mountState</code>暴露出来的，所以使用<code>setPending</code>就会触发一次状态更新。而<code>callback</code>是使用<code>startTransition</code>传入的回调函数，在回调函数内部使用了<code>setCount</code>，所以也会触发一次状态更新。</p> <p>获取<code>transition</code>相关的优先级的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> NoTransition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> TransitionLanes<span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000001111111111111111000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane1<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000001000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane2<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000010000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane3<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000100000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane4<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000001000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane5<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000010000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane6<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000100000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane7<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000001000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane8<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000010000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane9<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000100000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane10<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000000000001000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane11<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000000000010000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane12<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000000000100000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane13<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000000001000000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane14<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000000010000000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane15<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000000100000000000000000000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> TransitionLane16<span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000001000000000000000000000</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// order code...</span>

  <span class="token comment">// requestCurrentTransition会返回ReactCurrentBatchConfig.transition的值</span>
  <span class="token keyword">const</span> isTransition <span class="token operator">=</span> <span class="token function">requestCurrentTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoTransition<span class="token punctuation">;</span>
  <span class="token comment">// transition值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isTransition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// currentEventTransitionLane是全局变量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentEventTransitionLane <span class="token operator">===</span> NoLane<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果当前事件不存在TransitionLane，则需要获取</span>
      <span class="token comment">// 同一事件内所有transition都被分配同一个lane</span>
      currentEventTransitionLane <span class="token operator">=</span> <span class="token function">claimNextTransitionLane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回currentEventTransitionLane</span>
    <span class="token keyword">return</span> currentEventTransitionLane<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// order code...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">claimNextTransitionLane</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// 通过车道，分配每个新的transition到下一个车道。</span>
  <span class="token comment">// 在大多数情况下，每个transition都有自己的车道，直到用完所有的lane并循环回到最开始的lane。</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> nextTransitionLane<span class="token punctuation">;</span>
  <span class="token comment">// 将nextTransitionLane左移一位</span>
  nextTransitionLane <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// 用来判断transtion相关的lane是否用完</span>
  <span class="token comment">// nextTransitionLane按位与TransitionLanes，如果为空，说明transitionLane都用完了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nextTransitionLane <span class="token operator">&amp;</span> TransitionLanes<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将nextTransitionLane重置为TransitionLane1，即从头开始分配transtionLane</span>
    nextTransitionLane <span class="token operator">=</span> TransitionLane1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回</span>
  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从这段代码可以看到，与<code>transition</code>相关的<code>lane</code>一共有<em>16</em>位，说明可以最多存储<em>16</em>个不同的<code>transition</code>。</p> <p>至于为什么需要这么多位来存储<code>transition</code>，我猜测可能是为了应付并发场景的上限。虽然<code>transition</code>相比其他高优先级是比较低，但是当存在多个<code>transiton</code>时，他们之间也会存在优先级的相对关系。虽然都是通过<code>startTransition</code>的回调函数触发，但是还是应该有一个执行的前后顺序。先触发的<code>transition</code>就应该先执行，而后触发的<code>transition</code>就得后执行。</p> <p>综上所述，使用点击事件<code>handleClick</code>最终会触发四次状态更新。</p> <p>执行<code>setNum</code>会触发第一次状态更新，它对应的优先级是<code>SyncLane</code>。</p> <p>执行<code>setPending(true)</code>会触发第二次状态更新，它会根据当前存在更新的优先级和<code>ContinuousEventPriority</code>之间值更高的，显然<code>SyncLane</code>值更高，所以它对应的优先级也是<code>SyncLane</code>。</p> <p>执行<code>setPending(false)</code>会触发第三次状态更新，因为在这之前已经设置了<code>ReactCurrentBatchConfig.transition = 1</code>，所以接下来触发更新的优先级应该都是<code>transitionLane</code>。因为此时<code>currentEventTransitionLane</code>还没有值，所以会通过<code>claimNextTransitionLane</code>方法获取<code>lane</code>。<code>nextTransitionLane</code>的初始值是<code>TransitionLane1</code>，所以第三次状态更新对应的优先级就是<code>TransitionLane1</code>。</p> <p>执行<code>callback</code>内的<code>setCount</code>会触发第四次状态更新，也会进入获取<code>transitionLane</code>的逻辑。此时<code>currentEventTransitionLane</code>是有值的，为前一次更新的优先级<code>TransitionLane1</code>，所以第四次状态更新对应的优先级也是<code>TransitionLane1</code>。</p> <p>经过上述的分析结果，再结合<strong>批量更新</strong>：相同优先级的更新会<strong>合并</strong>到一次状态更新流程。</p> <p>结论：点击<code>handleClick</code>事件最终会触发两次组件渲染。第一次渲染会计算相同高优先级的<code>setNum</code>和<code>setPending(true)</code>。第二次渲染会计算相同低优先级的<code>setPending(false)</code>和<code>setCount</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react-blog/docs/hooks/useMemoAnduseCallback.html" class="prev">
        useMemo和useCallback
      </a></span> <span class="next"><a href="/react-blog/docs/concurrent/scheduler.html">
        Scheduler工作流程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/react-blog/assets/js/app.1296abc1.js" defer></script><script src="/react-blog/assets/js/2.2aa2ea89.js" defer></script><script src="/react-blog/assets/js/35.58ce8424.js" defer></script>
  </body>
</html>
