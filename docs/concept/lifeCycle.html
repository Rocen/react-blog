<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>生命周期 | React笔记</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/react-blog/logo.svg">
    <meta name="description" content="React">
    
    <link rel="preload" href="/react-blog/assets/css/0.styles.7c9b7da0.css" as="style"><link rel="preload" href="/react-blog/assets/js/app.1296abc1.js" as="script"><link rel="preload" href="/react-blog/assets/js/2.2aa2ea89.js" as="script"><link rel="preload" href="/react-blog/assets/js/22.17cddd5f.js" as="script"><link rel="prefetch" href="/react-blog/assets/js/10.eec084d2.js"><link rel="prefetch" href="/react-blog/assets/js/11.90e7ad9c.js"><link rel="prefetch" href="/react-blog/assets/js/12.ec712917.js"><link rel="prefetch" href="/react-blog/assets/js/13.5fd1705f.js"><link rel="prefetch" href="/react-blog/assets/js/14.33d6319e.js"><link rel="prefetch" href="/react-blog/assets/js/15.b49ac970.js"><link rel="prefetch" href="/react-blog/assets/js/16.915d1a33.js"><link rel="prefetch" href="/react-blog/assets/js/17.0d48f94a.js"><link rel="prefetch" href="/react-blog/assets/js/18.162dd664.js"><link rel="prefetch" href="/react-blog/assets/js/19.897cc694.js"><link rel="prefetch" href="/react-blog/assets/js/20.c0d68b54.js"><link rel="prefetch" href="/react-blog/assets/js/21.23f5c8b7.js"><link rel="prefetch" href="/react-blog/assets/js/23.3e2c069f.js"><link rel="prefetch" href="/react-blog/assets/js/24.16287cbc.js"><link rel="prefetch" href="/react-blog/assets/js/25.c9819b86.js"><link rel="prefetch" href="/react-blog/assets/js/26.03bcf156.js"><link rel="prefetch" href="/react-blog/assets/js/27.2e75196a.js"><link rel="prefetch" href="/react-blog/assets/js/28.71dcfa28.js"><link rel="prefetch" href="/react-blog/assets/js/29.0534c7d4.js"><link rel="prefetch" href="/react-blog/assets/js/3.1f92403b.js"><link rel="prefetch" href="/react-blog/assets/js/30.70a1b1a5.js"><link rel="prefetch" href="/react-blog/assets/js/31.8d8007c6.js"><link rel="prefetch" href="/react-blog/assets/js/32.f55b2b21.js"><link rel="prefetch" href="/react-blog/assets/js/33.dea713d0.js"><link rel="prefetch" href="/react-blog/assets/js/34.16302cd1.js"><link rel="prefetch" href="/react-blog/assets/js/35.58ce8424.js"><link rel="prefetch" href="/react-blog/assets/js/36.21c87dbf.js"><link rel="prefetch" href="/react-blog/assets/js/37.e9ccbb00.js"><link rel="prefetch" href="/react-blog/assets/js/38.eda7b7d3.js"><link rel="prefetch" href="/react-blog/assets/js/39.28c4eb15.js"><link rel="prefetch" href="/react-blog/assets/js/4.ace4b147.js"><link rel="prefetch" href="/react-blog/assets/js/40.13eceae9.js"><link rel="prefetch" href="/react-blog/assets/js/41.e5e3f4ba.js"><link rel="prefetch" href="/react-blog/assets/js/42.1ab022fc.js"><link rel="prefetch" href="/react-blog/assets/js/43.eca03ba8.js"><link rel="prefetch" href="/react-blog/assets/js/44.be104c53.js"><link rel="prefetch" href="/react-blog/assets/js/5.68075c63.js"><link rel="prefetch" href="/react-blog/assets/js/6.01147cc3.js"><link rel="prefetch" href="/react-blog/assets/js/7.630cc1a8.js"><link rel="prefetch" href="/react-blog/assets/js/8.80d0f023.js"><link rel="prefetch" href="/react-blog/assets/js/9.f8d3ba3a.js">
    <link rel="stylesheet" href="/react-blog/assets/css/0.styles.7c9b7da0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/react-blog/" class="home-link router-link-active"><!----> <span class="site-name">React笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://next-blog.irocen.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  nextjs笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/Rocen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://next-blog.irocen.top" target="_blank" rel="noopener noreferrer" class="nav-link external">
  nextjs笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/Rocen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/react-blog/" class="sidebar-heading clickable router-link-active"><span>开始</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-blog/docs/start/directory.html" class="sidebar-link">目录</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>理念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>概念</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react-blog/docs/concept/lifeCycle.html" aria-current="page" class="active sidebar-link">生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react-blog/docs/concept/lifeCycle.html#生命周期" class="sidebar-link">生命周期</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/concept/lifeCycle.html#生命周期的执行过程" class="sidebar-link">生命周期的执行过程</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/concept/lifeCycle.html#挂载阶段" class="sidebar-link">挂载阶段</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/concept/lifeCycle.html#更新阶段" class="sidebar-link">更新阶段</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/concept/lifeCycle.html#销毁阶段" class="sidebar-link">销毁阶段</a></li><li class="sidebar-sub-header"><a href="/react-blog/docs/concept/lifeCycle.html#不安全的生命周期" class="sidebar-link">不安全的生命周期</a></li></ul></li><li><a href="/react-blog/docs/concept/eventSystem.html" class="sidebar-link">事件系统</a></li><li><a href="/react-blog/docs/concept/errorBoundary.html" class="sidebar-link">错误边界</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hooks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Concurrent Mode</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实现</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>发现</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h2> <p>React官网对于生命周期的定义是：</p> <blockquote><p>我们可以为 class 组件声明一些特殊的方法，当组件挂载或卸载时就会去执行这些方法。这些方法叫做“生命周期函数”</p></blockquote> <p><a href="https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>可以查看完整的完整生命周期。</p> <h2 id="生命周期的执行过程"><a href="#生命周期的执行过程" class="header-anchor">#</a> 生命周期的执行过程</h2> <p>将组件分为挂载、更新和卸载三个阶段分别分析：</p> <h2 id="挂载阶段"><a href="#挂载阶段" class="header-anchor">#</a> 挂载阶段</h2> <h3 id="执行constructor"><a href="#执行constructor" class="header-anchor">#</a> 执行constructor</h3> <p>在<code>mount</code>时，首先会执行<code>constructClassInstance</code>方法，用来实例化<code>ClassComponent</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">constructClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter">workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  ctor<span class="token operator">:</span> any<span class="token punctuation">,</span>
  props<span class="token operator">:</span> any<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">let</span> isLegacyContextConsumer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> unmaskedContext <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
  <span class="token comment">// 获取执行上下文</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span><span class="token punctuation">(</span>contextType<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ctor就是类组件本身</span>
  <span class="token comment">// 获取组件的实例</span>
  <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctor</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取state</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> instance<span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token keyword">undefined</span>
      <span class="token operator">?</span> instance<span class="token punctuation">.</span>state
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 绑定updater，绑定组件与实例的关系：workInProgress.stateNode = instance;</span>
  <span class="token function">adoptClassInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回实例</span>
  <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在组件实例化之后，会调用mountClassInstance进行组件初始化。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mountClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter">workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  ctor<span class="token operator">:</span> any<span class="token punctuation">,</span>
  newProps<span class="token operator">:</span> any<span class="token punctuation">,</span>
  renderLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取组件的实例</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>refs <span class="token operator">=</span> emptyRefsObject<span class="token punctuation">;</span>
  <span class="token comment">// 初始化updateQueue</span>
  <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> contextType <span class="token operator">=</span> ctor<span class="token punctuation">.</span>contextType<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> contextType <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> contextType <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">readContext</span><span class="token punctuation">(</span>contextType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>disableLegacyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span>context <span class="token operator">=</span> emptyContextObject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> unmaskedContext <span class="token operator">=</span> <span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> ctor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">getMaskedContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> unmaskedContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化state</span>
  instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token comment">// 获取getDerivedStateFromProps方法</span>
  <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果存在getDerivedStateFromProps方法，则执行它</span>
    <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      ctor<span class="token punctuation">,</span>
      getDerivedStateFromProps<span class="token punctuation">,</span>
      newProps<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新赋值state，因为applyDerivedStateFromProps可能会修改state</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
      <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不存在getDerivedStateFromProps和getSnapshotBeforeUpdate，并且存在componentWillMount生命周期函数</span>
    <span class="token comment">// 调用componentWillMount</span>
    <span class="token function">callComponentWillMount</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算updateQueue上保存的update</span>
    <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新赋值state</span>
    instance<span class="token punctuation">.</span>state <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidMount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果存在componentDidMount生命周期函数</span>
    <span class="token keyword">let</span> fiberFlags<span class="token operator">:</span> Flags <span class="token operator">=</span> Update<span class="token punctuation">;</span>
    <span class="token comment">// 为当前Fiber节点标记Update flags，表示组件需要更新，在DOM节点挂载后会再调用componentDidMount方法</span>
    workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> fiberFlags<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="执行getderivedstatefromprops"><a href="#执行getderivedstatefromprops" class="header-anchor">#</a> 执行getDerivedStateFromProps</h3> <p>在初始化阶段，<code>getDerivedStateFromProps</code>是第二个执行的生命周期函数。值得注意的是，它是从<code>ctor</code>类上直接绑定的静态方法，传入的<code>props</code>，<code>state</code>。返回值将和之前的<code>state</code>合并，作为新的<code>state</code>，传递给组件实例使用。</p> <h3 id="执行componentwillmount"><a href="#执行componentwillmount" class="header-anchor">#</a> 执行componentWillMount</h3> <p>如果存在<code>getDerivedStateFromProps</code>和<code>getSnapshotBeforeUpdate</code>就不会执行生命周期<code>componentWillMount</code>。</p> <h3 id="执行render"><a href="#执行render" class="header-anchor">#</a> 执行render</h3> <p>在<code>finishClassComponent</code>方法中会执行<code>render</code>方法，即进行组件的渲染。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">finishClassComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  Component<span class="token operator">:</span> any<span class="token punctuation">,</span>
  shouldUpdate<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  hasContext<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  renderLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 更新ref</span>
  <span class="token function">markRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 是否捕获到错误</span>
  <span class="token keyword">const</span> didCaptureError <span class="token operator">=</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> DidCapture<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldUpdate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>didCaptureError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// shouldUpdate表示是否应该渲染组件</span>
    <span class="token comment">// 不需要渲染组件，并且没有捕获到错误，则复用上一次更新时的Fiber节点</span>
    <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取组件实例</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

  <span class="token comment">// Rerender</span>
  ReactCurrentOwner<span class="token punctuation">.</span>current <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    didCaptureError <span class="token operator">&amp;&amp;</span>
    <span class="token keyword">typeof</span> Component<span class="token punctuation">.</span>getDerivedStateFromError <span class="token operator">!==</span> <span class="token string">'function'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果捕获到错误了</span>
    <span class="token comment">// 不渲染组件</span>
    nextChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 否则，执行组件的render方法，进行组件渲染</span>
    nextChildren <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据组件渲染的结果创建对应的Fiber节点</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 保存state</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> instance<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
  <span class="token comment">// 返回创建的Fiber节点</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="执行componentdidmount"><a href="#执行componentdidmount" class="header-anchor">#</a> 执行componentDidMount</h3> <p>在<code>commot</code>阶段的<code>layout</code>阶段，会调用<code>commitLayoutEffectOnFiber</code>方法执行<code>componentDidMount</code>生命周期函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>
  <span class="token parameter">finishedRoot<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  finishedWork<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  committedLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 判断current fiber是否存在</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// current为null，说明是mount</span>
                    <span class="token comment">// 执行componentDidMount生命周期函数</span>
                    instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                     <span class="token comment">// current不为null，说明是update</span>
                    <span class="token keyword">const</span> prevProps <span class="token operator">=</span>
                        finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
                        <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps
                        <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>
                            finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                            current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
                    <span class="token comment">// 执行componentDidUpdate生命周期函数</span>
                    instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>
                        prevProps<span class="token punctuation">,</span>
                        prevState<span class="token punctuation">,</span>
                        instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>挂载阶段生命周期的执行顺序：<code>constructor</code> -&gt; <code>getDerivedStateFromProps</code> / <code>componentWillMount</code> -&gt; <code>render</code> -&gt; <code>componentDidMount</code></p> <h2 id="更新阶段"><a href="#更新阶段" class="header-anchor">#</a> 更新阶段</h2> <p>在更新阶段会调用<code>updateClassInstance</code>方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateClassInstance</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  workInProgress<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  ctor<span class="token operator">:</span> any<span class="token punctuation">,</span>
  newProps<span class="token operator">:</span> any<span class="token punctuation">,</span>
  renderLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token comment">// 从current fiber节点克隆updateQueue，然后赋值到workInProgress fiber</span>
  <span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> unresolvedOldProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
  <span class="token keyword">const</span> oldProps <span class="token operator">=</span>
    workInProgress<span class="token punctuation">.</span>type <span class="token operator">===</span> workInProgress<span class="token punctuation">.</span>elementType
      <span class="token operator">?</span> unresolvedOldProps
      <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span> unresolvedOldProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>props <span class="token operator">=</span> oldProps<span class="token punctuation">;</span>
  <span class="token keyword">const</span> unresolvedNewProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token comment">// 获取getDerivedStateFromProps方法</span>
  <span class="token keyword">const</span> getDerivedStateFromProps <span class="token operator">=</span> ctor<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">;</span>
  <span class="token comment">// 是否存在新生命周期函数</span>
  <span class="token keyword">const</span> hasNewLifecycles <span class="token operator">=</span>
    <span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
    <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
      <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillReceiveProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不存在新生命周期函数，并且存在componentWillReceiveProps生命周期函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      unresolvedOldProps <span class="token operator">!==</span> unresolvedNewProps <span class="token operator">||</span>
      oldContext <span class="token operator">!==</span> nextContext
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新旧props不相等时，或者上下文不相等时</span>
      <span class="token comment">// 调用componentWillReceiveProps生命周期函数</span>
      <span class="token function">callComponentWillReceiveProps</span><span class="token punctuation">(</span>
        workInProgress<span class="token punctuation">,</span>
        instance<span class="token punctuation">,</span>
        newProps<span class="token punctuation">,</span>
        nextContext<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取旧新state</span>
  <span class="token keyword">const</span> oldState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newState <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>state <span class="token operator">=</span> oldState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 计算update</span>
  <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取新state</span>
  newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    unresolvedOldProps <span class="token operator">===</span> unresolvedNewProps <span class="token operator">&amp;&amp;</span>
    oldState <span class="token operator">===</span> newState
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 旧新pros和旧新state都相等，说明不需要执行组件的渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//  存在componentDidUpdate生命周期函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        unresolvedOldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
        oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 旧props和旧state不相等</span>
        <span class="token comment">// 为Fiber节点标记Update flags</span>
        workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 存在getSnapshotBeforeUpdate生命周期函数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        unresolvedOldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
        oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 旧props和旧state不相等</span>
        <span class="token comment">// 为Fiber节点标记Snapshot flags</span>
        workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回false，表示不需要进行组件渲染</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> getDerivedStateFromProps <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存在getDerivedStateFromProps生命周期函数</span>
    <span class="token comment">// 执行getDerivedStateFromProps生命周期函数</span>
    <span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      ctor<span class="token punctuation">,</span>
      getDerivedStateFromProps<span class="token punctuation">,</span>
      newProps<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新赋值state</span>
    newState <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取shouldUpdate</span>
  <span class="token keyword">const</span> shouldUpdate <span class="token operator">=</span>
    <span class="token comment">// 是否调用forceUpdate方法</span>
    <span class="token function">checkHasForceUpdateAfterProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// 调用shouldComponentUpdate生命周期函数并获取返回结果</span>
    <span class="token function">checkShouldComponentUpdate</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span>
      ctor<span class="token punctuation">,</span>
      oldProps<span class="token punctuation">,</span>
      newProps<span class="token punctuation">,</span>
      oldState<span class="token punctuation">,</span>
      newState<span class="token punctuation">,</span>
      nextContext<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要进行组件熏染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span>hasNewLifecycles <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span>
        <span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行componentWillUpdate生命周期函数</span>
        instance<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>UNSAFE_componentWillUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行componentWillUpdate生命周期函数</span>
        instance<span class="token punctuation">.</span><span class="token function">UNSAFE_componentWillUpdate</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> newState<span class="token punctuation">,</span> nextContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 为Fiber节点标记Update flags</span>
      workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 为Fiber节点标记Snapshot flags</span>
      workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不需要进行组件渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        unresolvedOldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
        oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 旧props和旧state不相等</span>
        <span class="token comment">// 为Fiber节点标记Update flags</span>
        workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>getSnapshotBeforeUpdate <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        unresolvedOldProps <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedProps <span class="token operator">||</span>
        oldState <span class="token operator">!==</span> current<span class="token punctuation">.</span>memoizedState
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 旧props和旧state不相等</span>
        <span class="token comment">// 为Fiber节点标记Snapshot flags</span>
        workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 保存新props和新state</span>
    workInProgress<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> newState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 赋值新props和新state</span>
  instance<span class="token punctuation">.</span>props <span class="token operator">=</span> newProps<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
  instance<span class="token punctuation">.</span>context <span class="token operator">=</span> nextContext<span class="token punctuation">;</span>
  <span class="token comment">// 返回shouldUpdate</span>
  <span class="token keyword">return</span> shouldUpdate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="执行componentwillreceiveprops"><a href="#执行componentwillreceiveprops" class="header-anchor">#</a> 执行componentWillReceiveProps</h3> <p>首先判断<code>getDerivedStateFromProps</code>生命周期是否存在，如果不存在就执行<code>componentWillReceiveProps</code>生命周期。传入该生命周期的两个参数分别是<code>newProps</code>和<code>nextContext</code>。</p> <h3 id="执行getderivedstatefromprops-2"><a href="#执行getderivedstatefromprops-2" class="header-anchor">#</a> 执行getDerivedStateFromProps</h3> <p>然后执行生命周期<code>getDerivedStateFromProps</code>，返回的值用于合并<code>state</code>，生成新的<code>state</code>。</p> <h3 id="执行shouldcomponentupdate"><a href="#执行shouldcomponentupdate" class="header-anchor">#</a> 执行shouldComponentUpdate</h3> <p>接着执行生命周期<code>shouldComponentUpdate</code>，传入新的<code>props</code>、新的<code>state</code>和新的<code>context</code>。返回一个布尔值，决定是否渲染组件，即是否执行<code>render</code>函数。<br>
这里应该注意一个问题，<code>getDerivedStateFromProps</code>的返回值可以作为新的<code>state</code>，传递给<code>shouldComponentUpdate</code>。</p> <h3 id="执行componentwillupdate"><a href="#执行componentwillupdate" class="header-anchor">#</a> 执行componentWillUpdate</h3> <p>最后来执行生命周期<code>componentWillUpdate</code>。</p> <h3 id="执行render-2"><a href="#执行render-2" class="header-anchor">#</a> 执行render</h3> <p>与挂载阶段一样，都是通过<code>finishClassComponent</code>方法执行<code>render</code>方法。</p> <h3 id="执行getsnapshotbeforeupdate"><a href="#执行getsnapshotbeforeupdate" class="header-anchor">#</a> 执行getSnapshotBeforeUpdate</h3> <p>在<code>commit</code>阶段的<code>before mutation</code>阶段，调用<code>commitBeforeMutationEffectsOnFiber</code>方法执行<code>getSnapshotBeforeUpdate</code>，该生命周期的返回值将作为第三个参数<code>__reactInternalSnapshotBeforeUpdate</code>传递给<code>componentDidUpdate</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffectsOnFiber</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
          <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
          <span class="token comment">// 执行getSnapshotBeforeUpdate生命周期函数</span>
          <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>
            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> prevProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 赋值__reactInternalSnapshotBeforeUpdate</span>
          instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="执行componentdidupdate"><a href="#执行componentdidupdate" class="header-anchor">#</a> 执行componentDidUpdate</h3> <p>在<code>commit</code>阶段的<code>layout</code>阶段，调用<code>commitLayoutEffectOnFiber</code>方法执行<code>componentDidUpdate</code>生命周期函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>
  <span class="token parameter">finishedRoot<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  current<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  finishedWork<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  committedLanes<span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 判断current fiber是否存在</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// current不存在，说明是mount</span>
                    <span class="token comment">// 执行componentDidMount生命周期函数</span>
                    instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// current存在，说明是update</span>
                    <span class="token keyword">const</span> prevProps <span class="token operator">=</span>
                        finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
                        <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps
                        <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>
                            finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                            current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">,</span>
                            <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
                    <span class="token comment">// 执行componentDidUpdate生命周期函数</span>
                    instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>
                        prevProps<span class="token punctuation">,</span>
                        prevState<span class="token punctuation">,</span>
                        instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">,</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更新阶段生命周期的执行顺序：<code>componentWillReceiveProps</code>(props改变) / <code>getDerivedStateFromProps</code> -&gt; <code>shouldComponentUpdate</code> -&gt; <code>componentWillUpdate</code> -&gt; <code>render</code> -&gt; <code>getSnapshotBeforeUpdate</code> -&gt; <code>componentDidUpdate</code></p> <h2 id="销毁阶段"><a href="#销毁阶段" class="header-anchor">#</a> 销毁阶段</h2> <h3 id="执行componentwillunmount"><a href="#执行componentwillunmount" class="header-anchor">#</a> 执行componentWillUnmount</h3> <p>首先在<code>beginWork</code>中创建<code>Fiber</code>节点时会使用<code>reconcileChildren</code>方法对更新前后的<code>Fiber</code>节点进行<code>diff</code>比较，将需要删除的节点<code>push</code>到父级<code>Fiber</code>节点的<code>deletions</code>数组中，表示需要对这些<code>Fiber</code>节点执行删除操作。<br>
然后在<code>mutation</code>阶段会遍历<code>workInProgress Fiber</code>树，对于保存在<code>deletions</code>数组中<code>Fiber</code>节点会调用<code>commitDeletion</code>方法，在内部间接执行<code>commitUnmount</code>方法，最终执行实例的<code>componentWillUnmount</code>生命周期函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitUnmount</span><span class="token punctuation">(</span>
  <span class="token parameter">finishedRoot<span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  current<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  nearestMountedAncestor<span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">onCommitUnmount</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> ClassComponent<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 解绑ref</span>
      <span class="token function">safelyDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nearestMountedAncestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUnmount <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 该方法内部还会再调用callComponentWillUnmountWithTimer，再由这个方法执行instance.componentWillUnmount();</span>
        <span class="token function">safelyCallComponentWillUnmount</span><span class="token punctuation">(</span>
          current<span class="token punctuation">,</span>
          nearestMountedAncestor<span class="token punctuation">,</span>
          instance<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="不安全的生命周期"><a href="#不安全的生命周期" class="header-anchor">#</a> 不安全的生命周期</h2> <p>目前在<code>React</code>官网会特别提示有一些即将过时的生命周期：</p> <ul><li>UNSAFE_componentWillMount()</li> <li>UNSAFE_componentWillUpdate()</li> <li>UNSAFE_componentWillReceiveProps()</li></ul> <p>以上这些生命周期被定义为<strong>UNSAFE</strong>，即不安全的。这样做的原因是因为这些生命周期函数在新版本<code>React</code>中有可能会被执行多次，与旧版本的<code>React</code>表现是不一致的，所以<code>React</code>希望将这些不安全的生命周期废弃掉。</p> <p>新版本<code>React</code>与旧版本<code>React</code>相比变化最大的是<code>React</code>内部的工作机制从<strong>同步更新</strong>变为<strong>异步可中断的更新</strong>，其中关键到的一个新概念是<strong>优先级</strong>。</p> <p>什么是优先级？</p> <p><em>状态更新</em>由用户交互产生，用户心里对交互执行顺序有个预期。交互的预期<strong>顺序</strong>为交互产生的状态更新赋予不同<strong>优先级</strong>。</p> <p>如：</p> <ul><li>生命周期函数，是同步执行</li> <li>用户触发的操作，点击事件、输入事件也是同步执行</li> <li>交互事件，动画或渲染就需要高优先级执行</li></ul> <p>用具体的例子来说，最开始用户触发了一个低优先级的更新，当<em>低优先级更新</em>正在执行<code>render</code>阶段时又触发了一个<em>高优先级的更新</em>，那么<em>高优先级的更新</em>就会打断<em>低优先级的更新</em>，然后从根节点开始执行<em>高优先级的更新</em>。如果没有再触发更高优先级的更新，就会等<em>高优先级的更新</em>执行完后，再重新执行<em>低优先级的更新</em>。</p> <p>在这个过程中可以发现<em>低优先级的更新</em>会执行两次<code>render</code>阶段，而<code>componentWillXXX</code>等生命周期函数是在<code>render</code>阶段的<code>beginWork</code>中通过调用<code>updateClassInstance</code>方法<strong>同步</strong>执行。最终导致这些生命周期函数可能被执行两次，与旧版本的<code>React</code>表现（只会被调用一次）不一致。</p> <p>所以，新版本<code>React</code>将这三个生命周期标记为<strong>UNSAFE</strong>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react-blog/docs/principle/updateState.html" class="prev">
        状态更新
      </a></span> <span class="next"><a href="/react-blog/docs/concept/eventSystem.html">
        事件系统
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/react-blog/assets/js/app.1296abc1.js" defer></script><script src="/react-blog/assets/js/2.2aa2ea89.js" defer></script><script src="/react-blog/assets/js/22.17cddd5f.js" defer></script>
  </body>
</html>
